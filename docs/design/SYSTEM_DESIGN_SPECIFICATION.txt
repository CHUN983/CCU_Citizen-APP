================================================================================
                  citizenApp 系統設計規格文件
================================================================================

文件版本: 1.0
最後更新: 2025-11-21
專案名稱: citizenApp - 市民意見反映與管理系統
文件狀態: 正式版


================================================================================
目錄
================================================================================

壹、文件說明
貳、系統規格設計
    一、系統架構
    二、系統功能
        (一) 市民端功能
        (二) 管理端功能
    三、系統流程圖
        (一) 主要業務流程
        (二) 異常處理流程
        (三) 資料流程圖
    四、軟體組織架構


================================================================================
壹、文件說明
================================================================================

1.1 目的
--------
本文件旨在詳細描述 citizenApp 系統的設計規格，包含系統架構、功能規格、
流程設計及軟體組織架構。本文件供開發團隊、測試團隊、維護人員及專案
管理者參考使用。

1.2 範圍
--------
本文件涵蓋：
- 系統整體架構設計
- 市民端與管理端功能規格
- 主要業務流程與異常處理
- 軟體組織架構與模組設計
- UML 圖表說明

1.3 參考文件
-----------
- API_DOCUMENTATION.md - API 介面規格
- PROJECT_SUMMARY.md - 專案總覽
- TEST_PLAN.md - 測試計畫


================================================================================
貳、系統規格設計
================================================================================


--------------------------------------------------------------------------------
一、系統架構
--------------------------------------------------------------------------------

1.1 整體架構圖
==============

本系統採用三層式架構 (Three-Tier Architecture)，包含：
- 展示層 (Presentation Layer): 市民端與管理端前端應用
- 業務邏輯層 (Business Logic Layer): FastAPI 後端服務
- 資料存取層 (Data Access Layer): MySQL 資料庫


┌───────────────────────────────────────────────────────────────────────┐
│                           展示層 (Presentation Layer)                  │
├───────────────────────────────────────────────────────────────────────┤
│                                                                        │
│  ┌─────────────────────────┐      ┌─────────────────────────┐        │
│  │   市民端 (Citizen App)   │      │  管理端 (Admin Portal)  │        │
│  ├─────────────────────────┤      ├─────────────────────────┤        │
│  │ - Vue 3 + Vite          │      │ - Vue 3 + Vite          │        │
│  │ - Element Plus UI       │      │ - Element Plus UI       │        │
│  │ - Pinia (狀態管理)      │      │ - Pinia (狀態管理)      │        │
│  │ - Vue Router            │      │ - Vue Router            │        │
│  │ - Axios (HTTP Client)   │      │ - Axios (HTTP Client)   │        │
│  │ Port: 5174              │      │ Port: 5173              │        │
│  └─────────────────────────┘      └─────────────────────────┘        │
│                                                                        │
└───────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ HTTP/HTTPS
                                    │ REST API
                                    │ JSON
                                    ↓
┌───────────────────────────────────────────────────────────────────────┐
│                    業務邏輯層 (Business Logic Layer)                   │
├───────────────────────────────────────────────────────────────────────┤
│                                                                        │
│  ┌──────────────────────────────────────────────────────────────┐    │
│  │              FastAPI Application (Python 3.9+)                │    │
│  ├──────────────────────────────────────────────────────────────┤    │
│  │                      中間件層 (Middleware)                    │    │
│  │  - CORS 中間件 (跨域資源共享)                                 │    │
│  │  - JWT 認證中間件                                             │    │
│  │  - 請求日誌中間件                                             │    │
│  ├──────────────────────────────────────────────────────────────┤    │
│  │                      API 路由層 (Routes)                      │    │
│  │  - /auth        (認證服務)                                    │    │
│  │  - /opinions    (意見管理)                                    │    │
│  │  - /notifications (通知服務)                                  │    │
│  │  - /admin       (管理功能)                                    │    │
│  │  - /media       (多媒體服務)                                  │    │
│  │  - /categories  (分類管理)                                    │    │
│  ├──────────────────────────────────────────────────────────────┤    │
│  │                      服務層 (Services)                        │    │
│  │  - AuthService        (認證服務)                              │    │
│  │  - OpinionService     (意見業務邏輯)                          │    │
│  │  - NotificationService (通知服務)                             │    │
│  │  - ModerationService  (審核服務)                              │    │
│  │  - MediaService       (多媒體處理)                            │    │
│  ├──────────────────────────────────────────────────────────────┤    │
│  │                    數據模型層 (Models)                        │    │
│  │  - Pydantic Models (請求/回應驗證)                            │    │
│  │  - Database Models (ORM 映射)                                 │    │
│  └──────────────────────────────────────────────────────────────┘    │
│                          Port: 8000                                   │
│                       Server: Uvicorn (ASGI)                          │
│                                                                        │
└───────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ MySQL Protocol
                                    │ Connection Pool
                                    ↓
┌───────────────────────────────────────────────────────────────────────┐
│                    資料存取層 (Data Access Layer)                      │
├───────────────────────────────────────────────────────────────────────┤
│                                                                        │
│  ┌──────────────────────────────────────────────────────────────┐    │
│  │                  MySQL 8.0+ (InnoDB 引擎)                      │    │
│  ├──────────────────────────────────────────────────────────────┤    │
│  │  核心數據表 (13 個):                                          │    │
│  │                                                               │    │
│  │  1. users              - 用戶資料表                           │    │
│  │  2. categories         - 分類資料表 (樹狀結構)                │    │
│  │  3. opinions           - 意見主表                             │    │
│  │  4. opinion_media      - 意見多媒體附件表                     │    │
│  │  5. comments           - 評論表                               │    │
│  │  6. votes              - 投票表                               │    │
│  │  7. collections        - 收藏表                               │    │
│  │  8. tags               - 標籤表                               │    │
│  │  9. opinion_tags       - 意見-標籤關聯表                      │    │
│  │ 10. notifications      - 通知表                               │    │
│  │ 11. notification_milestones - 通知級距追蹤表                  │    │
│  │ 12. opinion_history    - 意見歷史/審計日誌表                  │    │
│  │ 13. subscriptions      - 訂閱表                               │    │
│  │                                                               │    │
│  └──────────────────────────────────────────────────────────────┘    │
│                                                                        │
└───────────────────────────────────────────────────────────────────────┘
                                    │
                                    ↓
┌───────────────────────────────────────────────────────────────────────┐
│                         檔案系統 (File System)                         │
├───────────────────────────────────────────────────────────────────────┤
│  uploads/                                                             │
│  ├── images/        - 圖片檔案 (.jpg, .png, .gif, .webp)              │
│  ├── videos/        - 影片檔案 (.mp4, .avi, .mov, .webm)              │
│  ├── audio/         - 音頻檔案 (.mp3, .wav, .ogg, .m4a)               │
│  └── thumbnails/    - 圖片縮圖                                        │
└───────────────────────────────────────────────────────────────────────┘


1.2 技術堆疊
============

前端技術:
- 框架: Vue 3 (Composition API)
- 建置工具: Vite 7.1.7
- UI 元件庫: Element Plus 2.11.5
- 狀態管理: Pinia 3.0.3
- 路由管理: Vue Router 4.6.3
- HTTP 客戶端: Axios 1.12.2
- 圖標庫: @element-plus/icons-vue 2.3.2

後端技術:
- 框架: FastAPI 0.109.0
- 服務器: Uvicorn 0.27.0 (ASGI)
- 資料驗證: Pydantic 2.5.3
- 資料庫驅動: mysql-connector-python 8.3.0
- ORM: SQLAlchemy 2.0.25
- 認證: JWT (PyJWT 2.8.0)
- 密碼加密: Bcrypt 4.1.2
- 檔案處理: python-multipart 0.0.6
- 圖片處理: Pillow 10.2.0

資料庫:
- MySQL 8.0+
- 儲存引擎: InnoDB
- 字元集: utf8mb4
- 排序規則: utf8mb4_unicode_ci


1.3 系統部署圖 (Deployment Diagram)
=====================================

```
┌─────────────────────────────────────────────────────────────┐
│                          使用者環境                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   ┌──────────────┐              ┌──────────────┐           │
│   │   市民使用者  │              │  管理員使用者 │           │
│   └──────┬───────┘              └──────┬───────┘           │
│          │                              │                   │
│          │  Web Browser                 │  Web Browser      │
│          │  (Chrome, Firefox, Safari)   │                   │
│          │                              │                   │
└──────────┼──────────────────────────────┼───────────────────┘
           │                              │
           │  HTTPS                       │  HTTPS
           │                              │
┌──────────┼──────────────────────────────┼───────────────────┐
│          ↓                              ↓                   │
│  ┌───────────────┐             ┌───────────────┐           │
│  │  Citizen App  │             │  Admin Portal │           │
│  │  (localhost)  │             │  (localhost)  │           │
│  │  Port: 5174   │             │  Port: 5173   │           │
│  └───────┬───────┘             └───────┬───────┘           │
│          │                             │                   │
│          └──────────┬──────────────────┘                   │
│                     │  HTTP REST API                       │
│                     ↓                                       │
│            ┌─────────────────┐                             │
│            │  FastAPI Server │                             │
│            │  (Uvicorn)      │                             │
│            │  Port: 8000     │                             │
│            └────────┬────────┘                             │
│                     │                                       │
│         ┌───────────┼───────────┐                          │
│         │           │           │                          │
│         ↓           ↓           ↓                          │
│    ┌─────────┐ ┌─────────┐ ┌─────────┐                   │
│    │  MySQL  │ │  File   │ │  Cache  │                   │
│    │Database │ │ Storage │ │ (Future)│                   │
│    │Port:3306│ │ uploads/│ │         │                   │
│    └─────────┘ └─────────┘ └─────────┘                   │
│                                                             │
│                      應用伺服器環境                         │
└─────────────────────────────────────────────────────────────┘
```


1.4 Component Diagram (元件圖)
================================

```
┌─────────────────────────────────────────────────────────────────┐
│                         Frontend Components                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────┐       ┌──────────────────────┐       │
│  │  Citizen App         │       │  Admin Dashboard     │       │
│  ├──────────────────────┤       ├──────────────────────┤       │
│  │ • OpinionList        │       │ • Dashboard          │       │
│  │ • OpinionDetail      │       │ • OpinionManagement  │       │
│  │ • OpinionCreate      │       │ • ModerationPanel    │       │
│  │ • UserProfile        │       │ • CommentManagement  │       │
│  │ • Notifications      │       │ • Analytics          │       │
│  │ • Login/Register     │       │ • UserManagement     │       │
│  └──────────┬───────────┘       └──────────┬───────────┘       │
│             │                              │                   │
│             └────────────┬─────────────────┘                   │
│                          │                                     │
│                  ┌───────▼────────┐                            │
│                  │  API Client    │                            │
│                  │  (Axios)       │                            │
│                  └───────┬────────┘                            │
│                          │                                     │
└──────────────────────────┼─────────────────────────────────────┘
                           │ HTTP/REST
┌──────────────────────────┼─────────────────────────────────────┐
│                          ↓                                      │
│                  ┌────────────────┐                            │
│                  │  API Gateway   │                            │
│                  │  (FastAPI)     │                            │
│                  └───────┬────────┘                            │
│                          │                                     │
│         ┌────────────────┼────────────────┐                   │
│         ↓                ↓                ↓                   │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐              │
│  │  Auth API  │  │Opinion API │  │Notification│              │
│  │            │  │            │  │    API     │              │
│  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘              │
│        │               │               │                      │
│        ↓               ↓               ↓                      │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐              │
│  │   Auth     │  │  Opinion   │  │Notification│              │
│  │  Service   │  │  Service   │  │  Service   │              │
│  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘              │
│        │               │               │                      │
│        └───────────────┼───────────────┘                      │
│                        ↓                                       │
│                 ┌──────────────┐                              │
│                 │  Database    │                              │
│                 │  Connection  │                              │
│                 └──────┬───────┘                              │
│                        │                                       │
└────────────────────────┼───────────────────────────────────────┘
                         ↓
                  ┌─────────────┐
                  │    MySQL    │
                  │   Database  │
                  └─────────────┘
```


--------------------------------------------------------------------------------
二、系統功能
--------------------------------------------------------------------------------

2.1 功能總覽
============

本系統提供市民端與管理端兩大功能模組，涵蓋意見提交、審核、互動、
通知等完整功能。


(一) 市民端功能
================

2.1.1 Use Case Diagram - 市民端
================================

```
                        市民端用例圖 (Citizen Use Cases)

    ┌──────────────────────────────────────────────────────────────┐
    │                         System Boundary                       │
    │                                                               │
    │                                                               │
┌───────┐                                                           │
│       │                  ┌─────────────────┐                     │
│ 市民  │──────────────────│   瀏覽意見      │                     │
│ 使用者 │                  └─────────────────┘                     │
│       │                           │                               │
│       │                           │ <<include>>                   │
│       │                           ↓                               │
│       │                  ┌─────────────────┐                     │
│       │                  │   搜尋與篩選    │                     │
│       │                  └─────────────────┘                     │
│       │                                                           │
│       │                  ┌─────────────────┐                     │
│       │──────────────────│   查看意見詳情  │                     │
│       │                  └─────────────────┘                     │
│       │                           │                               │
│       │                           │ <<include>>                   │
│       │                           ↓                               │
│       │                  ┌─────────────────┐                     │
│       │                  │ 查看多媒體附件  │                     │
│       │                  └─────────────────┘                     │
│       │                                                           │
│       │                  ┌─────────────────┐                     │
│       │──────────────────│   提交意見      │                     │
│       │                  └─────────────────┘                     │
│       │                           │                               │
│       │                           │ <<extend>>                    │
│       │                           ↓                               │
│       │                  ┌─────────────────┐                     │
│       │                  │ 上傳多媒體檔案  │                     │
│       │                  └─────────────────┘                     │
│       │                                                           │
│       │                  ┌─────────────────┐                     │
│       │──────────────────│   投票 (讚/支持) │                    │
│       │                  └─────────────────┘                     │
│       │                                                           │
│       │                  ┌─────────────────┐                     │
│       │──────────────────│   發表評論      │                     │
│       │                  └─────────────────┘                     │
│       │                                                           │
│       │                  ┌─────────────────┐                     │
│       │──────────────────│   收藏意見      │                     │
│       │                  └─────────────────┘                     │
│       │                                                           │
│       │                  ┌─────────────────┐                     │
│       │──────────────────│   查看通知      │                     │
│       │                  └─────────────────┘                     │
│       │                           │                               │
│       │                           │ <<extend>>                    │
│       │                           ↓                               │
│       │                  ┌─────────────────┐                     │
│       │                  │   標記已讀      │                     │
│       │                  └─────────────────┘                     │
│       │                                                           │
│       │                  ┌─────────────────┐                     │
│       │──────────────────│   管理個人資料  │                     │
│       │                  └─────────────────┘                     │
└───────┘                                                           │
                                                                    │
                                                                    │
└───────────────────────────────────────────────────────────────────┘
```


2.1.2 市民端功能詳細說明
========================

A. 使用者認證與管理
------------------
功能代碼: F-C-001
功能名稱: 使用者註冊
輸入: username, email, password
輸出: 註冊成功訊息, JWT Token
業務規則:
  - username 長度 3-50 字元，必須唯一
  - email 必須符合格式且唯一
  - password 最少 6 字元
  - 自動賦予 'citizen' 角色
  - 密碼使用 Bcrypt 加密 (12 rounds)

功能代碼: F-C-002
功能名稱: 使用者登入
輸入: username/email, password
輸出: JWT Token, 使用者資訊
業務規則:
  - 支援 username 或 email 登入
  - Token 有效期 24 小時
  - Token 包含: user_id, username, role
  - 使用 HS256 演算法簽名

功能代碼: F-C-003
功能名稱: 個人資料管理
輸入: 使用者 ID (from Token)
輸出: 個人資訊, 我的意見列表, 我的收藏列表
業務規則:
  - 僅能查看/編輯自己的資料
  - 顯示提交的意見統計
  - 顯示收藏的意見


B. 意見瀏覽系統
---------------
功能代碼: F-C-004
功能名稱: 意見列表瀏覽
輸入: 頁碼, 每頁筆數, 篩選條件, 排序方式
輸出: 分頁意見列表, 總筆數
業務規則:
  - 預設每頁顯示 20 筆
  - 支援按狀態篩選 (pending, approved, rejected, resolved)
  - 支援按分類篩選
  - 支援按地區篩選
  - 支援關鍵字搜尋 (標題、內容)
  - 排序選項: 最新、熱門、最多評論

功能代碼: F-C-005
功能名稱: 意見詳情查看
輸入: 意見 ID
輸出: 完整意見資訊, 附件, 投票數, 評論列表
業務規則:
  - 自動增加瀏覽次數 (view_count)
  - 顯示提交者資訊 (username, 提交時間)
  - 顯示所有已核准的附件
  - 顯示即時投票統計
  - 顯示最新 50 則評論


C. 意見提交系統
---------------
功能代碼: F-C-006
功能名稱: 創建意見
輸入: 標題, 內容, 分類, 地區, 座標, 公開性, 標籤, 多媒體檔案
輸出: 新建意見 ID, 成功訊息
業務規則:
  - 標題: 5-200 字元 (必填)
  - 內容: 至少 10 字元 (必填)
  - 分類: 可選
  - 座標: 經度 (-180 to 180), 緯度 (-90 to 90)
  - 預設狀態: pending (待審核)
  - 支援草稿功能 (status='draft')

功能代碼: F-C-007
功能名稱: 多媒體上傳
輸入: 檔案 (圖片/影片/音頻)
輸出: 檔案 URL, 檔案 ID
業務規則:
  圖片:
    - 格式: .jpg, .jpeg, .png, .gif, .webp
    - 大小上限: 10 MB
    - 自動生成縮圖 (800x600)
  影片:
    - 格式: .mp4, .avi, .mov, .wmv, .flv, .webm
    - 大小上限: 50 MB
  音頻:
    - 格式: .mp3, .wav, .ogg, .m4a, .aac
    - 大小上限: 50 MB
  - 檔名使用 UUID
  - 儲存於 uploads/{type}/ 目錄


D. 互動功能
-----------
功能代碼: F-C-008
功能名稱: 投票功能
輸入: 意見 ID, 投票類型 (like/support)
輸出: 投票成功訊息, 更新後的投票數
業務規則:
  - 每個用戶每個意見只能投一票
  - 支援取消投票 (Toggle)
  - 即時更新投票統計
  - 達到級距時發送通知 (1, 2, 4, 8, 16, 32...)

功能代碼: F-C-009
功能名稱: 評論功能
輸入: 意見 ID, 評論內容
輸出: 評論 ID, 成功訊息
業務規則:
  - 內容至少 10 字元
  - 自動記錄時間戳記
  - 發送通知給意見提交者
  - 支援軟刪除 (管理員可刪除)

功能代碼: F-C-010
功能名稱: 收藏功能
輸入: 意見 ID
輸出: 收藏狀態, 成功訊息
業務規則:
  - 支援新增/取消收藏
  - 個人收藏列表
  - 收藏不受意見狀態影響


E. 通知系統
-----------
功能代碼: F-C-011
功能名稱: 通知列表
輸入: 使用者 ID, 是否僅顯示未讀
輸出: 通知列表 (最近 50 則)
業務規則:
  - 按時間倒序排列
  - 顯示未讀計數
  - 通知類型:
    * comment - 新評論
    * like - 按讚級距達成
    * status_change - 狀態變更
    * merged - 意見被合併
    * approved - 意見已核准
    * rejected - 意見被拒絕

功能代碼: F-C-012
功能名稱: 標記已讀
輸入: 通知 ID
輸出: 成功訊息
業務規則:
  - 更新 is_read = TRUE
  - 更新未讀計數


(二) 管理端功能
================

2.2.1 Use Case Diagram - 管理端
================================

```
                       管理端用例圖 (Admin Use Cases)

    ┌──────────────────────────────────────────────────────────────┐
    │                         System Boundary                       │
    │                                                               │
    │                                                               │
┌───────┐                                                           │
│       │                  ┌─────────────────┐                     │
│管理員 │──────────────────│   登入系統      │                     │
│       │                  └─────────────────┘                     │
│       │                                                           │
│       │                  ┌─────────────────┐                     │
│       │──────────────────│ 查看儀表板統計  │                     │
│       │                  └─────────────────┘                     │
│       │                                                           │
│       │                  ┌─────────────────┐                     │
│       │──────────────────│ 查看所有意見    │                     │
│       │                  └─────────────────┘                     │
│       │                           │                               │
│       │                           │ <<extend>>                    │
│       │                           ↓                               │
│       │                  ┌─────────────────┐                     │
│       │                  │  篩選意見列表   │                     │
│       │                  └─────────────────┘                     │
│       │                                                           │
│       │                  ┌─────────────────┐                     │
│       │──────────────────│   審核意見      │                     │
│       │                  └─────────────────┘                     │
│       │                           │                               │
│       │           ┌───────────────┼───────────────┐              │
│       │           │               │               │              │
│       │           ↓               ↓               ↓              │
│       │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │
│       │  │  核准意見   │ │  拒絕意見   │ │  合併意見   │       │
│       │  └─────────────┘ └─────────────┘ └─────────────┘       │
│       │                                                           │
│       │                  ┌─────────────────┐                     │
│       │──────────────────│   管理評論      │                     │
│       │                  └─────────────────┘                     │
│       │                           │                               │
│       │                           │ <<include>>                   │
│       │                           ↓                               │
│       │                  ┌─────────────────┐                     │
│       │                  │   刪除評論      │                     │
│       │                  └─────────────────┘                     │
│       │                                                           │
│       │                  ┌─────────────────┐                     │
│       │──────────────────│   更新分類      │                     │
│       │                  └─────────────────┘                     │
│       │                                                           │
│       │                  ┌─────────────────┐                     │
│       │──────────────────│ 查看操作歷史    │                     │
│       │                  └─────────────────┘                     │
│       │                                                           │
│       │                  ┌─────────────────┐                     │
│       │──────────────────│   管理用戶      │                     │
│       │                  └─────────────────┘                     │
└───────┘                                                           │
                                                                    │
                                                                    │
└───────────────────────────────────────────────────────────────────┘
```


2.2.2 管理端功能詳細說明
========================

A. 管理員認證
-------------
功能代碼: F-A-001
功能名稱: 管理員登入
輸入: username, password
輸出: JWT Token, 管理員資訊
業務規則:
  - 僅限 role='admin' 或 'moderator' 登入
  - Token 包含角色資訊
  - 預設管理員帳號: admin/admin123


B. 儀表板
---------
功能代碼: F-A-002
功能名稱: 統計儀表板
輸入: 使用者 Token
輸出: 系統統計資訊
業務規則:
  - 待審核意見數量
  - 今日提交統計
  - 總意見數
  - 用戶活躍度
  - 熱門分類統計


C. 意見管理
-----------
功能代碼: F-A-003
功能名稱: 意見列表管理
輸入: 頁碼, 篩選條件
輸出: 所有意見列表 (包含未核准)
業務規則:
  - 顯示所有狀態的意見
  - 支援批量操作
  - 顯示提交者資訊
  - 顯示審核狀態


D. 審核功能
-----------
功能代碼: F-A-004
功能名稱: 核准意見
輸入: 意見 ID, 操作者 ID
輸出: 成功訊息
業務規則:
  - 需要 admin 或 moderator 權限
  - 更新 status='approved'
  - 發送核准通知給提交者
  - 記錄操作歷史 (opinion_history)

功能代碼: F-A-005
功能名稱: 拒絕意見
輸入: 意見 ID, 拒絕理由, 操作者 ID
輸出: 成功訊息
業務規則:
  - 需要 admin 或 moderator 權限
  - 更新 status='rejected'
  - 拒絕理由必填 (至少 10 字元)
  - 發送拒絕通知給提交者 (包含理由)
  - 記錄操作歷史

功能代碼: F-A-006
功能名稱: 合併意見
輸入: 原意見 ID, 目標意見 ID, 操作者 ID
輸出: 成功訊息
業務規則:
  - 需要 admin 或 moderator 權限
  - 設定 merged_to_id 指向目標意見
  - 不刪除原意見 (保留記錄)
  - 發送通知給原提交者
  - 記錄操作歷史


E. 評論管理
-----------
功能代碼: F-A-007
功能名稱: 刪除評論
輸入: 評論 ID, 操作者 ID
輸出: 成功訊息
業務規則:
  - 需要 admin 或 moderator 權限
  - 軟刪除 (is_deleted=TRUE)
  - 記錄 deleted_by, deleted_at
  - 保留評論內容供審計


F. 分類管理
-----------
功能代碼: F-A-008
功能名稱: 更新意見分類
輸入: 意見 ID, 新分類 ID, 操作者 ID
輸出: 成功訊息
業務規則:
  - 需要 admin 或 moderator 權限
  - 驗證分類 ID 存在
  - 記錄分類變更歷史


G. 審計日誌
-----------
功能代碼: F-A-009
功能名稱: 查看操作歷史
輸入: 意見 ID 或時間範圍
輸出: 操作歷史列表
業務規則:
  - 顯示所有變更記錄
  - 包含操作類型、操作者、時間、變更內容
  - 支援按意見或時間篩選


--------------------------------------------------------------------------------
三、系統流程圖
--------------------------------------------------------------------------------

3.1 (一) 主要業務流程
====================

3.1.1 意見提交與審核流程 (Sequence Diagram)
============================================

```
意見提交與審核流程序列圖

市民使用者    市民端前端      API Gateway     Opinion Service    Database      通知服務
    │              │              │                 │              │              │
    │   填寫表單    │              │                 │              │              │
    │──────────────>│              │                 │              │              │
    │              │              │                 │              │              │
    │  上傳多媒體   │              │                 │              │              │
    │──────────────>│              │                 │              │              │
    │              │POST /media/  │                 │              │              │
    │              │   upload     │                 │              │              │
    │              │─────────────>│                 │              │              │
    │              │              │  儲存檔案       │              │              │
    │              │              │─────────────────>│              │              │
    │              │              │  檔案 URL       │              │              │
    │              │<─────────────│<─────────────────│              │              │
    │              │              │                 │              │              │
    │  提交意見    │              │                 │              │              │
    │──────────────>│              │                 │              │              │
    │              │POST /opinions│                 │              │              │
    │              │─────────────>│                 │              │              │
    │              │              │ 驗證 JWT Token  │              │              │
    │              │              │─────────────────>│              │              │
    │              │              │                 │              │              │
    │              │              │ 驗證資料格式    │              │              │
    │              │              │─────────────────>│              │              │
    │              │              │                 │              │              │
    │              │              │  創建意見       │              │              │
    │              │              │  status=pending │              │              │
    │              │              │─────────────────>│ INSERT      │              │
    │              │              │                 │─────────────>│              │
    │              │              │                 │              │              │
    │              │              │  記錄歷史       │              │              │
    │              │              │─────────────────>│ INSERT      │              │
    │              │              │                 │  history    │              │
    │              │              │                 │─────────────>│              │
    │              │              │                 │              │              │
    │              │              │  意見 ID        │              │              │
    │              │<─────────────│<─────────────────│<─────────────│              │
    │   成功訊息   │              │                 │              │              │
    │<──────────────│              │                 │              │              │
    │              │              │                 │              │              │
    │              │              │                 │              │              │
    │              ┌─────────────審核階段─────────────┐            │              │
    │              │              │                 │              │              │
管理員           管理端前端                                                        │
    │              │              │                 │              │              │
    │  查看待審核   │              │                 │              │              │
    │  意見清單    │              │                 │              │              │
    │──────────────>│GET /opinions│                 │              │              │
    │              │?status=     │                 │              │              │
    │              │  pending    │                 │              │              │
    │              │─────────────>│ 驗證 JWT Token  │              │              │
    │              │              │ 檢查權限        │              │              │
    │              │              │─────────────────>│              │              │
    │              │              │                 │ SELECT       │              │
    │              │              │─────────────────>│─────────────>│              │
    │              │              │  意見列表       │              │              │
    │              │<─────────────│<─────────────────│<─────────────│              │
    │  意見列表    │              │                 │              │              │
    │<──────────────│              │                 │              │              │
    │              │              │                 │              │              │
    │  選擇並核准   │              │                 │              │              │
    │──────────────>│POST /admin/ │                 │              │              │
    │              │ opinions/:id│                 │              │              │
    │              │   /approve  │                 │              │              │
    │              │─────────────>│ 驗證權限        │              │              │
    │              │              │ (admin/        │              │              │
    │              │              │  moderator)    │              │              │
    │              │              │─────────────────>│              │              │
    │              │              │                 │              │              │
    │              │              │  更新狀態       │              │              │
    │              │              │  status=        │              │              │
    │              │              │  approved       │ UPDATE       │              │
    │              │              │─────────────────>│─────────────>│              │
    │              │              │                 │              │              │
    │              │              │  記錄歷史       │              │              │
    │              │              │─────────────────>│ INSERT      │              │
    │              │              │                 │  history    │              │
    │              │              │                 │─────────────>│              │
    │              │              │                 │              │              │
    │              │              │  發送通知       │              │              │
    │              │              │─────────────────────────────────────────────>│
    │              │              │                 │              │  建立通知   │
    │              │              │                 │              │<─────────────│
    │              │              │                 │              │              │
    │              │              │  成功訊息       │              │              │
    │              │<─────────────│<─────────────────│              │              │
    │   成功訊息   │              │                 │              │              │
    │<──────────────│              │                 │              │              │
    │              │              │                 │              │              │
```


3.1.2 投票與通知流程
====================

```
投票與級距通知流程

市民使用者    市民端前端      API Gateway     Opinion Service  NotificationService  Database
    │              │              │                 │              │              │
    │  點擊投票按鈕│              │                 │              │              │
    │──────────────>│              │                 │              │              │
    │              │POST /opinions│                 │              │              │
    │              │  /:id/vote   │                 │              │              │
    │              │─────────────>│ 驗證 Token      │              │              │
    │              │              │─────────────────>│              │              │
    │              │              │                 │              │              │
    │              │              │ 檢查是否已投票  │              │              │
    │              │              │─────────────────>│ SELECT      │              │
    │              │              │                 │─────────────>│              │
    │              │              │                 │  查詢結果   │              │
    │              │              │                 │<─────────────│              │
    │              │              │                 │              │              │
    │              │              │   已投票?       │              │              │
    │              │              │─────────────────>│              │              │
    │              │              │                 │              │              │
    │              │              │  若已投票:      │              │              │
    │              │              │  取消投票       │ DELETE       │              │
    │              │              │─────────────────>│─────────────>│              │
    │              │              │                 │              │              │
    │              │              │  若未投票:      │              │              │
    │              │              │  新增投票記錄   │ INSERT       │              │
    │              │              │─────────────────>│─────────────>│              │
    │              │              │                 │              │              │
    │              │              │ 查詢目前票數    │ SELECT       │              │
    │              │              │─────────────────>│  COUNT(*)   │              │
    │              │              │                 │─────────────>│              │
    │              │              │                 │  票數 N     │              │
    │              │              │                 │<─────────────│              │
    │              │              │                 │              │              │
    │              │              │ 檢查是否達級距  │              │              │
    │              │              │ (1,2,4,8,16...) │              │              │
    │              │              │─────────────────>│              │              │
    │              │              │                 │              │              │
    │              │              │  若達到級距:    │              │              │
    │              │              │  發送通知給     │              │              │
    │              │              │  意見提交者     │              │              │
    │              │              │─────────────────────────────>│              │
    │              │              │                 │  建立通知   │              │
    │              │              │                 │  type='like'│              │
    │              │              │                 │──────────────────────────>│
    │              │              │                 │  記錄級距   │              │
    │              │              │                 │──────────────────────────>│
    │              │              │                 │              │  INSERT     │
    │              │              │                 │              │  milestones │
    │              │              │                 │              │<─────────────│
    │              │              │                 │              │              │
    │              │              │  更新票數       │              │              │
    │              │<─────────────│<─────────────────│              │              │
    │  更新畫面    │              │                 │              │              │
    │<──────────────│              │                 │              │              │
    │              │              │                 │              │              │
```


3.1.3 評論流程
==============

```
評論提交流程

市民使用者    市民端前端      API Gateway     Opinion Service NotificationService  Database
    │              │              │                 │              │              │
    │  撰寫評論    │              │                 │              │              │
    │──────────────>│              │                 │              │              │
    │              │              │                 │              │              │
    │  提交評論    │              │                 │              │              │
    │──────────────>│POST /opinions│                 │              │              │
    │              │ /:id/comments│                 │              │              │
    │              │─────────────>│ 驗證 Token      │              │              │
    │              │              │─────────────────>│              │              │
    │              │              │                 │              │              │
    │              │              │ 驗證內容長度    │              │              │
    │              │              │ (>=10 字元)     │              │              │
    │              │              │─────────────────>│              │              │
    │              │              │                 │              │              │
    │              │              │  新增評論       │ INSERT       │              │
    │              │              │─────────────────>│─────────────>│              │
    │              │              │                 │              │              │
    │              │              │  更新評論計數   │ UPDATE       │              │
    │              │              │─────────────────>│─────────────>│              │
    │              │              │                 │              │              │
    │              │              │  查詢意見提交者 │ SELECT       │              │
    │              │              │─────────────────>│─────────────>│              │
    │              │              │                 │  user_id    │              │
    │              │              │                 │<─────────────│              │
    │              │              │                 │              │              │
    │              │              │  發送評論通知   │              │              │
    │              │              │  給意見提交者   │              │              │
    │              │              │─────────────────────────────>│              │
    │              │              │                 │  type=      │              │
    │              │              │                 │ 'comment'   │              │
    │              │              │                 │──────────────────────────>│
    │              │              │                 │              │              │
    │              │              │  評論 ID        │              │              │
    │              │<─────────────│<─────────────────│              │              │
    │  成功訊息    │              │                 │              │              │
    │<──────────────│              │                 │              │              │
    │              │              │                 │              │              │
```


3.2 (二) 異常處理流程
=====================

3.2.1 認證失敗處理流程
======================

```
認證與授權異常處理流程

使用者          前端應用        API Gateway     Auth Service      Database
    │              │              │                 │              │
    │  發送請求    │              │                 │              │
    │──────────────>│              │                 │              │
    │              │  HTTP Request│                 │              │
    │              │  with Token  │                 │              │
    │              │─────────────>│                 │              │
    │              │              │ 驗證 JWT Token  │              │
    │              │              │─────────────────>│              │
    │              │              │                 │              │
    │              │              │ Token 驗證      │              │
    │              │              │─────────────────>│              │
    │              │              │                 │              │
    │              │              │   驗證結果      │              │
    │              │              ├─────────────────┤              │
    │              │              │                 │              │
    │              │              │  [Token 有效]   │              │
    │              │              │  繼續處理請求   │              │
    │              │              │                 │              │
    │              │              │                 │              │
    │              │              │  [Token 無效]   │              │
    │              │              │  401            │              │
    │              │              │  Unauthorized   │              │
    │              │<─────────────│                 │              │
    │              │              │                 │              │
    │              │  檢測 401    │                 │              │
    │              │  錯誤        │                 │              │
    │              │              │                 │              │
    │              │  清除 Token  │                 │              │
    │              │  from        │                 │              │
    │              │  localStorage│                 │              │
    │              │              │                 │              │
    │              │  重定向到    │                 │              │
    │              │  登入頁面    │                 │              │
    │              │              │                 │              │
    │  顯示登入    │              │                 │              │
    │  頁面        │              │                 │              │
    │<──────────────│              │                 │              │
    │              │              │                 │              │
    │              │              │                 │              │
    │              │              │  [Token 過期]   │              │
    │              │              │  401            │              │
    │              │              │  "Token expired"│              │
    │              │<─────────────│                 │              │
    │              │              │                 │              │
    │              │  顯示過期    │                 │              │
    │  "請重新登入"│  訊息        │                 │              │
    │<──────────────│              │                 │              │
    │              │              │                 │              │
    │              │              │                 │              │
    │              │              │ [權限不足]      │              │
    │              │              │ 403 Forbidden   │              │
    │              │<─────────────│                 │              │
    │              │              │                 │              │
    │  "權限不足"  │              │                 │              │
    │<──────────────│              │                 │              │
    │              │              │                 │              │
```


3.2.2 檔案上傳異常處理
======================

```
檔案上傳異常處理流程

使用者          前端應用        API Gateway     Media Service   File System
    │              │              │                 │              │
    │  選擇檔案    │              │                 │              │
    │──────────────>│              │                 │              │
    │              │              │                 │              │
    │              │ 前端檔案驗證 │                 │              │
    │              │              │                 │              │
    │              │ [檢查檔案]   │                 │              │
    │              ├──────────────┤                 │              │
    │              │              │                 │              │
    │              │ 檔案大小     │                 │              │
    │              │ 超過限制?    │                 │              │
    │              │              │                 │              │
    │  "檔案過大"  │  YES         │                 │              │
    │<──────────────│  停止上傳   │                 │              │
    │              │              │                 │              │
    │              │  NO          │                 │              │
    │              │              │                 │              │
    │              │ 檔案類型     │                 │              │
    │              │ 不支援?      │                 │              │
    │              │              │                 │              │
    │  "不支援的   │  YES         │                 │              │
    │   檔案類型"  │  停止上傳   │                 │              │
    │<──────────────│              │                 │              │
    │              │              │                 │              │
    │              │  NO          │                 │              │
    │              │              │                 │              │
    │              │POST /media/  │                 │              │
    │              │  upload      │                 │              │
    │              │─────────────>│ 後端驗證        │              │
    │              │              │─────────────────>│              │
    │              │              │                 │              │
    │              │              │ [再次驗證]      │              │
    │              │              │ - 檔案大小      │              │
    │              │              │ - MIME 類型     │              │
    │              │              │ - 副檔名        │              │
    │              │              │                 │              │
    │              │              │  驗證失敗?      │              │
    │              │              │  400            │              │
    │              │              │  Bad Request    │              │
    │              │<─────────────│                 │              │
    │  顯示錯誤    │              │                 │              │
    │  訊息        │              │                 │              │
    │<──────────────│              │                 │              │
    │              │              │                 │              │
    │              │              │  驗證通過       │              │
    │              │              │  儲存檔案       │              │
    │              │              │─────────────────────────────>│
    │              │              │                 │              │
    │              │              │  儲存失敗?      │              │
    │              │              │  (磁碟空間不足) │              │
    │              │              │  500            │              │
    │              │              │  Server Error   │              │
    │              │<─────────────│                 │              │
    │              │              │                 │              │
    │              │  重試機制    │                 │              │
    │              │  (最多 3 次) │                 │              │
    │              │              │                 │              │
    │  "上傳失敗   │              │                 │              │
    │   請稍後再試"│              │                 │              │
    │<──────────────│              │                 │              │
    │              │              │                 │              │
    │              │              │  成功儲存       │              │
    │              │              │  檔案 URL       │              │
    │              │<─────────────│<─────────────────<─────────────│
    │              │              │                 │              │
    │  顯示預覽    │              │                 │              │
    │<──────────────│              │                 │              │
    │              │              │                 │              │
```


3.2.3 資料庫連線異常處理
========================

```
資料庫連線異常處理

API Gateway     Database Pool   MySQL Database
    │              │              │
    │  請求連線    │              │
    │─────────────>│              │
    │              │  獲取連線    │
    │              │─────────────>│
    │              │              │
    │              │  [連線正常]  │
    │              │  連線物件    │
    │<─────────────│<─────────────│
    │  執行查詢    │              │
    │─────────────>│─────────────>│
    │              │              │
    │              │              │
    │              │  [連線失敗]  │
    │              │  Connection  │
    │              │   Error      │
    │              │<─────────────│
    │              │              │
    │              │  重試連線    │
    │              │  (最多 3 次) │
    │              │─────────────>│
    │              │              │
    │              │  [仍然失敗]  │
    │              │<─────────────│
    │              │              │
    │              │  記錄錯誤    │
    │              │  log.error() │
    │              │              │
    │  500         │              │
    │  "Database   │              │
    │   Error"     │              │
    │<─────────────│              │
    │              │              │
    │  返回通用    │              │
    │  錯誤訊息    │              │
    │  給使用者    │              │
    │              │              │
    │              │              │
    │              │  [連線池滿]  │
    │              │  Pool        │
    │              │  Exhausted   │
    │              │              │
    │  等待連線    │              │
    │  (timeout    │              │
    │   30 秒)     │              │
    │              │              │
    │              │  超時?       │
    │              │              │
    │  503         │              │
    │  "Service    │              │
    │   Busy"      │              │
    │<─────────────│              │
    │              │              │
```


3.3 (三) 資料流程圖
===================

3.3.1 資料流程圖 Level 0 (Context Diagram)
==========================================

```
                      系統環境圖 (Context Diagram)


    ┌─────────────┐                         ┌─────────────┐
    │             │    瀏覽意見              │             │
    │             │    提交意見              │             │
    │   市民使用者 │    評論/投票            │   管理員    │
    │             │    查看通知              │             │
    │             │                          │             │
    └──────┬──────┘                         └──────┬──────┘
           │                                       │
           │  意見資訊                             │  審核決定
           │  互動記錄                             │  操作記錄
           ↓                                       ↓
    ┌──────────────────────────────────────────────────────┐
    │                                                       │
    │                                                       │
    │              citizenApp 市民意見系統                  │
    │                                                       │
    │         (處理意見提交、審核、互動、通知)              │
    │                                                       │
    │                                                       │
    └───────────────────┬──────────────────────────────────┘
                        │
                        │  儲存/讀取資料
                        ↓
                 ┌──────────────┐
                 │              │
                 │  MySQL       │
                 │  Database    │
                 │              │
                 └──────────────┘
```


3.3.2 資料流程圖 Level 1 (Main Processes)
==========================================

```
                   資料流程圖 Level 1 (主要流程)


市民使用者                                                管理員
    │                                                       │
    │  [1.1] 註冊/登入                                     │ [2.1] 管理員登入
    ↓                                                       ↓
┌─────────┐ Token                                     ┌─────────┐
│ 1.0     │───────────────────┐                       │ 2.0     │
│ 使用者  │                   │                       │ 管理    │
│ 認證    │                   │                       │ 認證    │
└────┬────┘                   │                       └────┬────┘
     │                        │                            │
     │ 使用者資料             │                            │ 管理員資料
     ↓                        │                            ↓
[D1: users]                   │                       [D1: users]
     │                        │                            │
     │  [1.2] 提交意見        │                            │
     ↓                        ↓                            │
┌─────────┐              ┌─────────┐                      │
│ 3.0     │ 意見資料      │ 4.0     │                      │
│ 意見    │──────────────>│ 資料    │                      │
│ 管理    │              │ 儲存    │                      │
└────┬────┘              └────┬────┘                      │
     │                        │                            │
     │                        │ 儲存意見                   │
     │                        ↓                            │
     │                   [D2: opinions]                    │
     │                        │                            │
     │  [1.3] 上傳檔案        │                            │
     ↓                        │                            │
┌─────────┐              ┌─────────┐                      │
│ 5.0     │ 檔案資料      │ 6.0     │                      │
│ 多媒體  │──────────────>│ 檔案    │                      │
│ 處理    │              │ 儲存    │                      │
└─────────┘              └────┬────┘                      │
                              │                            │
                              │ 檔案路徑                   │
                              ↓                            │
                         [D3: media]                       │
                              │                            │
     ┌────────────────────────┘                            │
     │                                                     │
     │  [1.4] 投票                                        │ [2.2] 審核意見
     ↓                                                     ↓
┌─────────┐ 投票記錄                                 ┌─────────┐
│ 7.0     │─────────>  [D4: votes]                   │ 8.0     │
│ 投票    │                                           │ 意見    │
│ 系統    │            [D5: comments]  <─────────────│ 審核    │
└─────────┘                  ↑                        └────┬────┘
     ↑                       │ 評論記錄                    │
     │  [1.5] 評論          │                             │ 審核結果
     └──────────────────────┘                             ↓
                                                      [D6: opinion_history]
                                                           │
                                                           │ 狀態變更
                                                           ↓
┌─────────┐ 通知資料                                 ┌─────────┐
│ 9.0     │<────────────────────────────────────────│ 10.0    │
│ 通知    │                                          │ 事件    │
│ 服務    │                                          │ 觸發    │
└────┬────┘                                          └─────────┘
     │                                                     ↑
     │ 通知記錄                                            │
     ↓                                                     │
[D7: notifications]                                       │
     │                                                     │
     │ 通知訊息                                           │
     ↓                                                     │
市民使用者                                                │
     │                                                     │
     │  [1.6] 查看通知                                    │
     └─────────────────────────────────────────────────────┘


資料儲存說明:
[D1: users]          - 使用者資料表
[D2: opinions]       - 意見資料表
[D3: media]          - 多媒體附件表
[D4: votes]          - 投票記錄表
[D5: comments]       - 評論記錄表
[D6: opinion_history] - 審核歷史表
[D7: notifications]  - 通知記錄表
```


3.3.3 核心資料流程詳細說明
==========================

流程 3.0 - 意見管理:
------------------
輸入: 使用者 Token, 意見內容, 多媒體檔案
處理:
  1. 驗證使用者身份
  2. 驗證意見內容格式
  3. 產生意見 ID
  4. 設定預設狀態 (pending)
  5. 關聯多媒體檔案
  6. 記錄提交時間
輸出: 意見 ID, 成功訊息
資料存取: INSERT opinions, INSERT opinion_media

流程 5.0 - 多媒體處理:
---------------------
輸入: 上傳檔案, 檔案類型
處理:
  1. 驗證檔案類型和大小
  2. 生成唯一檔名 (UUID)
  3. 儲存至檔案系統
  4. 生成縮圖 (若為圖片)
  5. 記錄檔案資訊
輸出: 檔案 URL, 檔案 ID
資料存取: INSERT opinion_media

流程 7.0 - 投票系統:
-------------------
輸入: 使用者 ID, 意見 ID, 投票類型
處理:
  1. 檢查是否已投票
  2. 若已投票則取消 (DELETE)
  3. 若未投票則新增 (INSERT)
  4. 更新投票計數
  5. 檢查級距觸發
  6. 若達級距則通知
輸出: 投票狀態, 最新票數
資料存取: SELECT votes, INSERT/DELETE votes, SELECT COUNT

流程 8.0 - 意見審核:
-------------------
輸入: 管理員 Token, 意見 ID, 審核決定, 理由
處理:
  1. 驗證管理員權限
  2. 更新意見狀態
  3. 記錄審核歷史
  4. 記錄操作者
  5. 觸發通知事件
輸出: 審核結果, 成功訊息
資料存取: UPDATE opinions, INSERT opinion_history, INSERT notifications

流程 9.0 - 通知服務:
-------------------
輸入: 使用者 ID, 通知類型, 相關 ID, 訊息內容
處理:
  1. 產生通知 ID
  2. 組織通知訊息
  3. 記錄通知時間
  4. 設定未讀狀態
  5. 儲存通知記錄
輸出: 通知 ID
資料存取: INSERT notifications


--------------------------------------------------------------------------------
四、軟體組織架構
--------------------------------------------------------------------------------

4.1 專案目錄結構
================

```
citizenApp/
├── src/
│   ├── main/
│   │   ├── js/                          # JavaScript 前端代碼
│   │   │   ├── citizen-portal/          # 市民端應用
│   │   │   │   ├── src/
│   │   │   │   │   ├── assets/          # 靜態資源
│   │   │   │   │   ├── components/      # Vue 元件
│   │   │   │   │   │   ├── OpinionCard.vue
│   │   │   │   │   │   ├── CommentList.vue
│   │   │   │   │   │   ├── VoteButton.vue
│   │   │   │   │   │   └── MediaUpload.vue
│   │   │   │   │   ├── views/           # 頁面視圖
│   │   │   │   │   │   ├── Home.vue
│   │   │   │   │   │   ├── OpinionList.vue
│   │   │   │   │   │   ├── OpinionDetail.vue
│   │   │   │   │   │   ├── OpinionCreate.vue
│   │   │   │   │   │   ├── Profile.vue
│   │   │   │   │   │   └── Notifications.vue
│   │   │   │   │   ├── stores/          # Pinia 狀態管理
│   │   │   │   │   │   ├── auth.js
│   │   │   │   │   │   ├── opinion.js
│   │   │   │   │   │   └── notification.js
│   │   │   │   │   ├── router/          # 路由配置
│   │   │   │   │   │   └── index.js
│   │   │   │   │   ├── api/             # API 客戶端
│   │   │   │   │   │   ├── client.js
│   │   │   │   │   │   ├── auth.js
│   │   │   │   │   │   ├── opinions.js
│   │   │   │   │   │   └── notifications.js
│   │   │   │   │   ├── utils/           # 工具函數
│   │   │   │   │   │   ├── format.js
│   │   │   │   │   │   ├── validate.js
│   │   │   │   │   │   └── constants.js
│   │   │   │   │   ├── App.vue          # 根元件
│   │   │   │   │   └── main.js          # 入口文件
│   │   │   │   ├── package.json
│   │   │   │   └── vite.config.js
│   │   │   │
│   │   │   └── admin-dashboard/         # 管理端應用
│   │   │       ├── src/
│   │   │       │   ├── components/      # 管理端元件
│   │   │       │   │   ├── OpinionTable.vue
│   │   │       │   │   ├── ModerationPanel.vue
│   │   │       │   │   └── StatsCard.vue
│   │   │       │   ├── views/           # 管理端頁面
│   │   │       │   │   ├── Dashboard.vue
│   │   │       │   │   ├── OpinionManagement.vue
│   │   │       │   │   ├── CommentManagement.vue
│   │   │       │   │   └── Analytics.vue
│   │   │       │   ├── stores/
│   │   │       │   ├── router/
│   │   │       │   ├── api/
│   │   │       │   └── main.js
│   │   │       ├── package.json
│   │   │       └── vite.config.js
│   │   │
│   │   └── python/                      # Python 後端代碼
│   │       ├── core/                    # 核心業務邏輯
│   │       │   ├── __init__.py
│   │       │   ├── config.py            # 配置管理
│   │       │   ├── database.py          # 資料庫連線
│   │       │   └── security.py          # 安全相關
│   │       │
│   │       ├── models/                  # 資料模型
│   │       │   ├── __init__.py
│   │       │   ├── user.py              # 使用者模型
│   │       │   ├── opinion.py           # 意見模型
│   │       │   ├── comment.py           # 評論模型
│   │       │   ├── vote.py              # 投票模型
│   │       │   ├── notification.py      # 通知模型
│   │       │   └── media.py             # 多媒體模型
│   │       │
│   │       ├── services/                # 服務層
│   │       │   ├── __init__.py
│   │       │   ├── auth_service.py      # 認證服務
│   │       │   ├── opinion_service.py   # 意見業務邏輯
│   │       │   ├── notification_service.py  # 通知服務
│   │       │   ├── moderation_service.py    # 審核服務
│   │       │   └── media_service.py     # 多媒體服務
│   │       │
│   │       ├── api/                     # API 路由
│   │       │   ├── __init__.py
│   │       │   ├── auth.py              # /auth 路由
│   │       │   ├── opinions.py          # /opinions 路由
│   │       │   ├── notifications.py     # /notifications 路由
│   │       │   ├── moderation.py        # /admin 路由
│   │       │   ├── media.py             # /media 路由
│   │       │   └── categories.py        # /categories 路由
│   │       │
│   │       ├── utils/                   # 工具函數
│   │       │   ├── __init__.py
│   │       │   ├── validators.py        # 驗證工具
│   │       │   ├── helpers.py           # 輔助函數
│   │       │   └── constants.py         # 常數定義
│   │       │
│   │       ├── middleware/              # 中間件
│   │       │   ├── __init__.py
│   │       │   ├── auth.py              # JWT 驗證中間件
│   │       │   └── cors.py              # CORS 中間件
│   │       │
│   │       ├── main.py                  # FastAPI 主程式
│   │       └── requirements.txt         # Python 依賴
│   │
│   └── test/                            # 測試代碼
│       ├── unit/                        # 單元測試
│       │   ├── test_auth.py
│       │   ├── test_opinions.py
│       │   └── test_notifications.py
│       └── integration/                 # 整合測試
│           ├── test_opinion_workflow.py
│           └── test_moderation.py
│
├── docs/                                # 文件
│   ├── api/                             # API 文件
│   ├── design/                          # 設計文件
│   ├── dev/                             # 開發文件
│   ├── testing/                         # 測試文件
│   └── user/                            # 使用者文件
│
├── uploads/                             # 上傳檔案目錄
│   ├── images/
│   ├── videos/
│   ├── audio/
│   └── thumbnails/
│
├── .env                                 # 環境變數
├── .gitignore
├── CLAUDE.md                            # Claude Code 規則
├── README.md
└── LICENSE
```


4.2 Class Diagram (核心類別圖)
===============================

```
                        核心類別圖 (Core Class Diagram)


┌─────────────────────────┐
│      User               │
├─────────────────────────┤
│ - id: int               │
│ - username: str         │
│ - email: str            │
│ - password_hash: str    │
│ - full_name: str        │
│ - role: enum            │
│ - is_active: bool       │
│ - created_at: datetime  │
│ - updated_at: datetime  │
├─────────────────────────┤
│ + register()            │
│ + login()               │
│ + update_profile()      │
│ + check_permission()    │
└───────┬─────────────────┘
        │ 1
        │
        │ submits
        │
        │ *
┌───────▼─────────────────┐                 ┌─────────────────────────┐
│      Opinion            │                 │      Category           │
├─────────────────────────┤                 ├─────────────────────────┤
│ - id: int               │       *    1    │ - id: int               │
│ - user_id: int          │────belongs to───│ - name: str             │
│ - title: str            │                 │ - parent_id: int        │
│ - content: text         │                 │ - description: text     │
│ - category_id: int      │                 │ - created_at: datetime  │
│ - status: enum          │                 ├─────────────────────────┤
│ - region: str           │                 │ + get_subcategories()   │
│ - latitude: decimal     │                 │ + get_parent()          │
│ - longitude: decimal    │                 └─────────────────────────┘
│ - view_count: int       │
│ - is_public: bool       │
│ - merged_to_id: int     │
│ - created_at: datetime  │
│ - updated_at: datetime  │
├─────────────────────────┤
│ + submit()              │
│ + approve()             │
│ + reject()              │
│ + merge_to()            │
│ + update_status()       │
│ + increment_views()     │
└───┬────────────┬────────┘
    │ 1          │ 1
    │            │
    │ has        │ has
    │            │
    │ *          │ *
┌───▼────────────▼───────┐         ┌─────────────────────────┐
│    OpinionMedia        │         │      Comment            │
├────────────────────────┤         ├─────────────────────────┤
│ - id: int              │         │ - id: int               │
│ - opinion_id: int      │         │ - opinion_id: int       │
│ - media_type: enum     │         │ - user_id: int          │
│ - file_path: str       │         │ - content: text         │
│ - file_size: int       │         │ - is_deleted: bool      │
│ - mime_type: str       │         │ - deleted_by: int       │
│ - created_at: datetime │         │ - deleted_at: datetime  │
├────────────────────────┤         │ - created_at: datetime  │
│ + upload()             │         ├─────────────────────────┤
│ + delete()             │         │ + post()                │
│ + generate_thumbnail() │         │ + soft_delete()         │
└────────────────────────┘         └─────────────────────────┘


        ┌───────────────────────────────┐
        │                               │
        │ 1                             │ 1
┌───────▼─────────────────┐     ┌───────▼─────────────────┐
│      Vote               │     │    Notification         │
├─────────────────────────┤     ├─────────────────────────┤
│ - id: int               │     │ - id: int               │
│ - opinion_id: int       │     │ - user_id: int          │
│ - user_id: int          │     │ - opinion_id: int       │
│ - vote_type: enum       │     │ - type: enum            │
│ - created_at: datetime  │     │ - title: str            │
├─────────────────────────┤     │ - content: text         │
│ + toggle()              │     │ - is_read: bool         │
│ + get_count()           │     │ - created_at: datetime  │
│ + check_milestone()     │     ├─────────────────────────┤
└─────────────────────────┘     │ + send()                │
                                │ + mark_as_read()        │
                                │ + get_unread_count()    │
                                └─────────────────────────┘


┌─────────────────────────┐
│    OpinionHistory       │
├─────────────────────────┤
│ - id: int               │
│ - opinion_id: int       │
│ - action: enum          │
│ - old_status: enum      │
│ - new_status: enum      │
│ - changed_by: int       │
│ - reason: text          │
│ - change_data: json     │
│ - created_at: datetime  │
├─────────────────────────┤
│ + record_change()       │
│ + get_history()         │
└─────────────────────────┘


關聯說明:
- User (1) ---submits---> (*) Opinion
- User (1) ---makes-----> (*) Comment
- User (1) ---casts-----> (*) Vote
- User (1) ---receives--> (*) Notification
- Opinion (*) ---belongs to---> (1) Category
- Opinion (1) ---has---------> (*) OpinionMedia
- Opinion (1) ---has---------> (*) Comment
- Opinion (1) ---has---------> (*) Vote
- Opinion (1) ---has---------> (*) OpinionHistory
```


4.3 模組分層架構
================

```
┌───────────────────────────────────────────────────────────────┐
│                      Presentation Layer                       │
│                         (展示層)                              │
├───────────────────────────────────────────────────────────────┤
│                                                                │
│  Vue 3 Components (市民端 + 管理端)                           │
│  - Views (頁面元件)                                           │
│  - Components (可重用元件)                                    │
│  - Stores (Pinia 狀態管理)                                    │
│  - Router (路由管理)                                          │
│                                                                │
└───────────────────────────┬───────────────────────────────────┘
                            │
                            │ HTTP/REST API
                            │ JSON
                            ↓
┌───────────────────────────────────────────────────────────────┐
│                      API Layer                                 │
│                      (API 層)                                  │
├───────────────────────────────────────────────────────────────┤
│                                                                │
│  FastAPI Routers                                              │
│  - auth.py          (認證 API)                                │
│  - opinions.py      (意見 API)                                │
│  - notifications.py (通知 API)                                │
│  - moderation.py    (審核 API)                                │
│  - media.py         (多媒體 API)                              │
│  - categories.py    (分類 API)                                │
│                                                                │
│  Middleware                                                   │
│  - JWT 驗證                                                   │
│  - CORS 處理                                                  │
│  - 請求日誌                                                   │
│                                                                │
└───────────────────────────┬───────────────────────────────────┘
                            │
                            │ Function Calls
                            │
                            ↓
┌───────────────────────────────────────────────────────────────┐
│                      Service Layer                             │
│                      (服務層)                                  │
├───────────────────────────────────────────────────────────────┤
│                                                                │
│  Business Logic Services                                      │
│  - AuthService          (使用者認證與授權)                    │
│  - OpinionService       (意見業務邏輯)                        │
│  - NotificationService  (通知業務邏輯)                        │
│  - ModerationService    (審核業務邏輯)                        │
│  - MediaService         (多媒體處理)                          │
│                                                                │
│  Business Rules                                               │
│  - 資料驗證                                                   │
│  - 權限檢查                                                   │
│  - 業務規則執行                                               │
│  - 事件觸發                                                   │
│                                                                │
└───────────────────────────┬───────────────────────────────────┘
                            │
                            │ Data Models
                            │ SQL Queries
                            ↓
┌───────────────────────────────────────────────────────────────┐
│                      Data Access Layer                         │
│                      (資料存取層)                              │
├───────────────────────────────────────────────────────────────┤
│                                                                │
│  Database Connection                                          │
│  - Connection Pool (連線池)                                   │
│  - Context Manager (上下文管理)                               │
│  - Transaction Management (交易管理)                          │
│                                                                │
│  Data Models                                                  │
│  - Pydantic Models (請求/回應驗證)                            │
│  - Database Schemas (資料庫結構定義)                          │
│                                                                │
│  CRUD Operations                                              │
│  - Create (新增)                                              │
│  - Read (查詢)                                                │
│  - Update (更新)                                              │
│  - Delete (刪除)                                              │
│                                                                │
└───────────────────────────┬───────────────────────────────────┘
                            │
                            │ MySQL Protocol
                            │
                            ↓
┌───────────────────────────────────────────────────────────────┐
│                      Database Layer                            │
│                      (資料庫層)                                │
├───────────────────────────────────────────────────────────────┤
│                                                                │
│  MySQL 8.0+ (InnoDB Engine)                                   │
│  - 13 個核心資料表                                            │
│  - 外鍵約束                                                   │
│  - 索引優化                                                   │
│  - 全文搜尋索引                                               │
│  - 交易支援                                                   │
│                                                                │
└───────────────────────────────────────────────────────────────┘
```


4.4 安全架構
============

```
安全機制架構


┌───────────────────────────────────────────────────────────────┐
│                      前端安全                                  │
├───────────────────────────────────────────────────────────────┤
│                                                                │
│  • JWT Token 儲存於 localStorage                              │
│  • 自動在 HTTP 請求標頭加入 Token                             │
│  • 接收 401 自動登出並重定向                                  │
│  • 敏感操作二次確認                                           │
│  • XSS 防護 (Vue 自動跳脫)                                    │
│  • 檔案上傳前端驗證 (類型、大小)                              │
│                                                                │
└───────────────────────────┬───────────────────────────────────┘
                            │
                            │ HTTPS (生產環境)
                            │
                            ↓
┌───────────────────────────────────────────────────────────────┐
│                      API 閘道安全                              │
├───────────────────────────────────────────────────────────────┤
│                                                                │
│  • CORS 中間件 (限制來源)                                     │
│  • JWT 驗證中間件                                             │
│  • 請求速率限制 (Rate Limiting) [未來實作]                    │
│  • 請求大小限制                                               │
│  • Content-Type 驗證                                          │
│                                                                │
└───────────────────────────┬───────────────────────────────────┘
                            │
                            ↓
┌───────────────────────────────────────────────────────────────┐
│                      認證與授權                                │
├───────────────────────────────────────────────────────────────┤
│                                                                │
│  JWT (JSON Web Token)                                         │
│  • 演算法: HS256                                              │
│  • 有效期: 24 小時                                            │
│  • Payload: user_id, username, role                           │
│  • Secret Key 儲存於環境變數                                  │
│                                                                │
│  Role-Based Access Control (RBAC)                             │
│  • citizen   - 一般市民權限                                   │
│  • moderator - 審核員權限                                     │
│  • admin     - 管理員權限                                     │
│                                                                │
│  密碼安全                                                     │
│  • Bcrypt 加密 (12 rounds)                                    │
│  • 不儲存明文密碼                                             │
│  • 密碼強度要求 (最少 6 字元)                                 │
│                                                                │
└───────────────────────────┬───────────────────────────────────┘
                            │
                            ↓
┌───────────────────────────────────────────────────────────────┐
│                      資料驗證                                  │
├───────────────────────────────────────────────────────────────┤
│                                                                │
│  Pydantic 模型驗證                                            │
│  • 資料類型驗證                                               │
│  • 必填欄位檢查                                               │
│  • 長度限制                                                   │
│  • 格式驗證 (email, URL 等)                                   │
│                                                                │
│  SQL 注入防護                                                 │
│  • 參數化查詢 (Parameterized Queries)                         │
│  • 不使用字串拼接 SQL                                         │
│  • 輸入過濾                                                   │
│                                                                │
└───────────────────────────┬───────────────────────────────────┘
                            │
                            ↓
┌───────────────────────────────────────────────────────────────┐
│                      檔案上傳安全                              │
├───────────────────────────────────────────────────────────────┤
│                                                                │
│  • 檔案類型白名單驗證                                         │
│  • 檔案大小限制 (圖片 10MB, 影片/音頻 50MB)                   │
│  • MIME 類型驗證                                              │
│  • 唯一檔名 (UUID)                                            │
│  • 儲存路徑隔離 (避免路徑遍歷攻擊)                            │
│  • 禁止執行上傳檔案                                           │
│                                                                │
└───────────────────────────┬───────────────────────────────────┘
                            │
                            ↓
┌───────────────────────────────────────────────────────────────┐
│                      資料庫安全                                │
├───────────────────────────────────────────────────────────────┤
│                                                                │
│  • 資料庫使用者權限最小化                                     │
│  • 連線加密 (SSL/TLS) [生產環境]                              │
│  • 敏感資料加密儲存                                           │
│  • 定期備份                                                   │
│  • 審計日誌記錄                                               │
│                                                                │
└───────────────────────────────────────────────────────────────┘
```


4.5 效能優化架構
================

前端優化:
--------
- Vue 3 Composition API (減少記憶體使用)
- 元件懶加載 (Lazy Loading)
- 圖片懶加載
- 虛擬滾動 (長列表)
- Vite 快速建置
- 程式碼分割 (Code Splitting)

後端優化:
--------
- 資料庫連線池 (Connection Pooling)
- 查詢優化 (適當的索引)
- 分頁查詢 (避免一次載入大量資料)
- 非同步處理 (FastAPI Async)
- 快取機制 [未來實作]
  * Redis 快取熱門意見
  * 查詢結果快取

資料庫優化:
----------
- 適當的索引設計
  * PRIMARY KEY 索引
  * FOREIGN KEY 索引
  * FULLTEXT 索引 (全文搜尋)
  * UNIQUE 索引 (防止重複)
- 查詢優化
  * 避免 SELECT *
  * 使用 JOIN 取代多次查詢
  * 限制查詢結果數量 (LIMIT)
- 定期維護
  * 分析表格統計資訊
  * 重建索引
  * 清理過期資料


4.6 擴展性設計
==============

水平擴展準備:
------------
- 無狀態 API 設計 (Stateless)
- JWT Token 認證 (不依賴 Session)
- 檔案儲存可遷移至物件儲存 (S3, MinIO)
- 資料庫讀寫分離準備
- 負載平衡器支援

垂直擴展:
--------
- 資料庫效能調校
- 增加連線池大小
- 伺服器硬體升級

微服務化準備:
------------
- 模組化設計
- 清楚的服務邊界
- API 優先設計
- 事件驅動架構準備


================================================================================
附錄
================================================================================

A. 資料庫結構詳細定義
=====================

詳見專案中的資料庫 Schema 檔案:
- src/main/python/core/database.py
- docs/api/API_DOCUMENTATION.md


B. API 端點詳細定義
===================

詳見專案文件:
- docs/api/API_DOCUMENTATION.md


C. 測試計畫
===========

詳見專案文件:
- docs/testing/TEST_PLAN.md
- docs/testing/TEST_CASES.md
- docs/testing/TRACEABILITY_MATRIX.md


D. 部署指南
===========

詳見專案文件:
- docs/user/SETUP_GUIDE.md
- README.md


E. 專案狀態
===========

詳見專案文件:
- PROJECT_STATUS.md
- SPRINT1_COMPLETION_REPORT.md


F. UML 圖表說明
===============

本文件使用的 UML 圖表類型:

1. Component Diagram (元件圖)
   - 展示系統元件及其關係
   - 位置: 1.4 節

2. Deployment Diagram (部署圖)
   - 展示系統部署架構
   - 位置: 1.3 節

3. Use Case Diagram (用例圖)
   - 展示使用者與系統的互動
   - 位置: 2.1.1 節 (市民端), 2.2.1 節 (管理端)

4. Sequence Diagram (序列圖)
   - 展示物件間的訊息交換順序
   - 位置: 3.1.1, 3.1.2, 3.1.3 節 (業務流程)
   - 位置: 3.2.1, 3.2.2, 3.2.3 節 (異常處理)

5. Data Flow Diagram (資料流程圖)
   - 展示資料在系統中的流動
   - 位置: 3.3.1, 3.3.2 節

6. Class Diagram (類別圖)
   - 展示系統的類別結構與關聯
   - 位置: 4.2 節


================================================================================
版本歷史
================================================================================

版本 1.0 - 2025-11-21
- 初始版本
- 完整記錄系統架構與設計
- 包含完整的 UML 圖表說明


================================================================================
文件結束
================================================================================

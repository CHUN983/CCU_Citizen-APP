name: CI/CD Pipeline

# è§¸ç™¼æ¢ä»¶ï¼šPush æˆ– Pull Request åˆ° main åˆ†æ”¯
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# ç’°å¢ƒè®Šæ•¸
env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'

jobs:
  # ==========================================
  # Job 1: ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
  # ==========================================
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 black pylint

      - name: ğŸ” Lint with flake8
        run: |
          # åœæ­¢æ§‹å»ºå¦‚æœæœ‰èªæ³•éŒ¯èª¤æˆ–æœªå®šç¾©åç¨±
          flake8 src/main/python --count --select=E9,F63,F7,F82 --show-source --statistics
          # è­¦å‘Šè¤‡é›œåº¦å’Œå…¶ä»–å•é¡Œ
          flake8 src/main/python --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        continue-on-error: true

      - name: ğŸ¨ Check code formatting with Black
        run: |
          black --check src/main/python
        continue-on-error: true

  # ==========================================
  # Job 2: å‰ç«¯æ¸¬è©¦
  # ==========================================
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: src/main/js/admin-dashboard/package-lock.json

      - name: ğŸ“¦ Install dependencies
        run: |
          cd src/main/js/admin-dashboard
          npm ci

      - name: ğŸ” Lint code
        run: |
          cd src/main/js/admin-dashboard
          npm run lint
        continue-on-error: true

      - name: ğŸ—ï¸ Build project
        run: |
          cd src/main/js/admin-dashboard
          npm run build

      - name: ğŸ§ª Run unit tests
        run: |
          cd src/main/js/admin-dashboard
          npm run test
        continue-on-error: true

      - name: ğŸ“Š Generate coverage report
        run: |
          cd src/main/js/admin-dashboard
          npm run test:coverage
        continue-on-error: true

      - name: ğŸ“¤ Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-coverage
          path: src/main/js/admin-dashboard/coverage/
          retention-days: 7

  # ==========================================
  # Job 3: å¾Œç«¯å–®å…ƒæ¸¬è©¦
  # ==========================================
  backend-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    needs: code-quality

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: citizen_app_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: â³ Wait for MySQL
        run: |
          for i in {1..30}; do
            if mysqladmin ping -h 127.0.0.1 -uroot -ptest_password --silent; then
              echo "MySQL is ready!"
              break
            fi
            echo "Waiting for MySQL... ($i/30)"
            sleep 2
          done

      - name: ğŸ—„ï¸ Setup test database
        run: |
          mysql -h 127.0.0.1 -uroot -ptest_password citizen_app_test < src/main/resources/config/schema.sql
          mysql -h 127.0.0.1 -uroot -ptest_password citizen_app_test < src/main/resources/config/update_roles.sql
        env:
          MYSQL_PWD: test_password

      - name: ğŸ§ª Run tests
        run: |
          # å¦‚æœæœ‰æ¸¬è©¦æª”æ¡ˆå°±åŸ·è¡Œ
          if [ -d "src/test" ]; then
            pytest src/test -v --tb=short
          else
            echo "No tests found, skipping..."
          fi
        env:
          DB_HOST: 127.0.0.1
          DB_USER: root
          DB_PASSWORD: test_password
          DB_NAME: citizen_app_test
          JWT_SECRET_KEY: test-secret-key

      - name: ğŸ“Š Generate coverage report
        run: |
          if [ -d "src/test" ]; then
            pip install pytest-cov
            pytest src/test --cov=src/main/python --cov-report=xml --cov-report=html
          fi
        continue-on-error: true

  # ==========================================
  # Job 4: API å¥åº·æª¢æŸ¥
  # ==========================================
  api-health-check:
    name: API Health Check
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: citizen_app_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ—„ï¸ Setup database
        run: |
          mysql -h 127.0.0.1 -uroot -ptest_password citizen_app_test < src/main/resources/config/schema.sql
          mysql -h 127.0.0.1 -uroot -ptest_password citizen_app_test < src/main/resources/config/update_roles.sql

      - name: ğŸš€ Start FastAPI server
        run: |
          python -m uvicorn src.main.python.core.app:app --host 0.0.0.0 --port 8000 &
          sleep 5
        env:
          DB_HOST: 127.0.0.1
          DB_USER: root
          DB_PASSWORD: test_password
          DB_NAME: citizen_app_test
          JWT_SECRET_KEY: test-secret-key

      - name: ğŸ¥ Health check
        run: |
          curl -f http://localhost:8000/health || exit 1
          curl -f http://localhost:8000/ || exit 1
          echo "âœ… API is healthy!"

      - name: ğŸ“‹ Check API endpoints
        run: |
          # æª¢æŸ¥ä¸»è¦ç«¯é»æ˜¯å¦å­˜åœ¨
          response=$(curl -s http://localhost:8000/openapi.json)
          echo "$response" | grep -q "/auth/login" && echo "âœ… Auth endpoints found"
          echo "$response" | grep -q "/opinions" && echo "âœ… Opinion endpoints found"
          echo "$response" | grep -q "/media/upload" && echo "âœ… Media endpoints found"
          echo "$response" | grep -q "/admin" && echo "âœ… Admin endpoints found"

  # ==========================================
  # Job 5: å®‰å…¨æ€§æƒæ
  # ==========================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ”’ Run Bandit security check
        run: |
          pip install bandit
          bandit -r src/main/python -f json -o bandit-report.json
        continue-on-error: true

      - name: ğŸ“¦ Check for vulnerabilities in dependencies
        run: |
          pip install safety
          safety check --json
        continue-on-error: true

  # ==========================================
  # Job 6: æ§‹å»º Docker Imageï¼ˆå¯é¸ï¼‰
  # ==========================================
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [backend-tests, api-health-check]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build Docker image (dry run)
        run: |
          echo "Docker build would happen here"
          echo "Image tag: citizenapp:${{ github.sha }}"
        # å¯¦éš›æ§‹å»ºï¼ˆéœ€è¦ Dockerfileï¼‰ï¼š
        # docker build -t citizenapp:${{ github.sha }} .

  # ==========================================
  # Job 7: éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒï¼ˆå¯é¸ï¼‰
  # ==========================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-docker]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: staging
      url: https://staging.citizenapp.example.com

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy notification
        run: |
          echo "ğŸ‰ Deployment to staging would happen here"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"

  # ==========================================
  # Job 8: é€šçŸ¥
  # ==========================================
  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests, api-health-check, security-scan]
    if: always()

    steps:
      - name: ğŸ“§ Send notification
        run: |
          if [ "${{ needs.frontend-tests.result }}" == "success" ] && \
             [ "${{ needs.backend-tests.result }}" == "success" ] && \
             [ "${{ needs.api-health-check.result }}" == "success" ]; then
            echo "âœ… CI/CD Pipeline completed successfully!"
            echo "All tests passed and API is healthy"
          else
            echo "âŒ CI/CD Pipeline failed"
            echo "Frontend tests: ${{ needs.frontend-tests.result }}"
            echo "Backend tests: ${{ needs.backend-tests.result }}"
            echo "API health: ${{ needs.api-health-check.result }}"
            echo "Security: ${{ needs.security-scan.result }}"
          fi
